var express = require('express');
var router = express.Router();
const { createAuction } = require('../models/auction');
const fs = require('fs');
const { Octokit, App, Action } = require("octokit");
const { createAppAuth } = require("@octokit/auth-app");
const { Webhooks, createNodeMiddleware } = require("@octokit/webhooks");
const webhooks = new Webhooks({
	  secret: process.env.ARTIFY_BOT_TOKEN
});

/* GET users listing. */
router.post('/', async function(req, res, next) {
  //todo verify signature
  
  try{
    const verification = await webhooks.verifyAndReceive({
          id: req.headers['x-request-id'],
          name: req.headers['x-github-event'],
          signature: req.headers['x-hub-signature'],
          payload: req.body
    });
    console.log(verification);
  } catch(e){
    console.log("Signature failed",e);
    return res.send("NOK");
  }

  try{
    if(
      req.body.action==="created"
      && req.body.comment.body.startsWith("/artify")
    ){
      const parts = req.body.comment.body.match(/\"(.*?)\"/g);
      console.log(req.body.comment.body, parts);
      const auction = await createAuction(req.body.comment.html_url.split("#")[0],parts[0], parts[1]);
      const octokit = new Octokit({
        authStrategy: createAppAuth,
        auth: {
          appId: 122465,
          privateKey: fs.readFileSync('./github.pem'),
          installationId: req.body.installation.id,
        },
      });


      await octokit.request('PATCH /repos/{owner}/{repo}/comments/{comment_id}', {
	        owner: req.body.repository.owner.login,
	        repo: req.body.repository.name,
	        comment_id: req.body.comment.id,
	        body: "This commit has been artified at : https://topcommits.com/auctions/"+auction.nftPublicKey
      });
    }
	
  }
  catch(e){
    console.log(e);
  }
  finally{
    res.send("OK");
  }
  
});




/*




{                                                                                                                                                                                     action: 'created',                                                                                                                                                                  comment: {                                                                                                                                                                            url: 'https://api.github.com/repos/madhavanmalolan/test/comments/52450352',                                                                                                         html_url: 'https://github.com/madhavanmalolan/test/commit/098a9332105d687a39a109f067844d71236afedf#commitcomment-52450352',                                                         id: 52450352,                                                                                                                                                                       node_id: 'MDEzOkNvbW1pdENvbW1lbnQ1MjQ1MDM1Mg==',                                                                                                                                    user: {                                                                                                                                                                               login: 'madhavanmalolan',                                                                                                                                                           id: 2111253,                                                                                                                                                                        node_id: 'MDQ6VXNlcjIxMTEyNTM=',                                                                                                                                                    avatar_url: 'https://avatars.githubusercontent.com/u/2111253?v=4',                                                                                                                  gravatar_id: '',                                                                                                                                                                    url: 'https://api.github.com/users/madhavanmalolan',                                                                                                                                html_url: 'https://github.com/madhavanmalolan',                                                                                                                                     followers_url: 'https://api.github.com/users/madhavanmalolan/followers',                                                                                                            following_url: 'https://api.github.com/users/madhavanmalolan/following{/other_user}',                                                                                               gists_url: 'https://api.github.com/users/madhavanmalolan/gists{/gist_id}',                                                                                                          starred_url: 'https://api.github.com/users/madhavanmalolan/starred{/owner}{/repo}',                                                                                                 subscriptions_url: 'https://api.github.com/users/madhavanmalolan/subscriptions',                                                                                                    organizations_url: 'https://api.github.com/users/madhavanmalolan/orgs',                                                                                                             repos_url: 'https://api.github.com/users/madhavanmalolan/repos',                                                                                                                    events_url: 'https://api.github.com/users/madhavanmalolan/events{/privacy}',                                                                                                        received_events_url: 'https://api.github.com/users/madhavanmalolan/received_events',                                                                                                type: 'User',                                                                                                                                                                       site_admin: false                                                                                                                                                                 },                                                                                                                                                                                  position: null,                                                                                                                                                                     line: null,                                                                                                                                                                         path: null,                                                                                                                                                                         commit_id: '098a9332105d687a39a109f067844d71236afedf',                                                                                                                              created_at: '2021-06-21T13:35:06Z',                                                                                                                                                 updated_at: '2021-06-21T13:35:06Z',                                                                                                                                                 author_association: 'OWNER',                                                                                                                                                        body: 'cool'                                                                                                                                                                      },                                                                                                                                                                                  repository: {                                                                                                                                                                         id: 378937388,                                                                                                                                                                      node_id: 'MDEwOlJlcG9zaXRvcnkzNzg5MzczODg=',                                                                                                                                        name: 'test',                                                                                                                                                                       full_name: 'madhavanmalolan/test',                                                                                                                                                  private: false,                                                                                                                                                                     owner: {                                                                                                                                                                              login: 'madhavanmalolan',                                                                                                                                                           id: 2111253,                                                                                                                                                                        node_id: 'MDQ6VXNlcjIxMTEyNTM=',                                                                                                                                                    avatar_url: 'https://avatars.githubusercontent.com/u/2111253?v=4',                                                                                                                  gravatar_id: '',                                                                                                                                                                    url: 'https://api.github.com/users/madhavanmalolan',                                                                                                                                html_url: 'https://github.com/madhavanmalolan',                                                                                                                                     followers_url: 'https://api.github.com/users/madhavanmalolan/followers',                                                                                                            following_url: 'https://api.github.com/users/madhavanmalolan/following{/other_user}',                                                                                               gists_url: 'https://api.github.com/users/madhavanmalolan/gists{/gist_id}',                                                                                                          starred_url: 'https://api.github.com/users/madhavanmalolan/starred{/owner}{/repo}',                                                                                                 subscriptions_url: 'https://api.github.com/users/madhavanmalolan/subscriptions',                                                                                                    organizations_url: 'https://api.github.com/users/madhavanmalolan/orgs',                                                                                                             repos_url: 'https://api.github.com/users/madhavanmalolan/repos',                                                                                                                    events_url: 'https://api.github.com/users/madhavanmalolan/events{/privacy}',                                                                                                        received_events_url: 'https://api.github.com/users/madhavanmalolan/received_events',                                                                                                type: 'User',                                                                                                                                                                       site_admin: false                                                                                                                                                                 },                                                                                                                                                                                  html_url: 'https://github.com/madhavanmalolan/test',                                                                                                                                description: null,                                                                                                                                                                  fork: false,                                                                                                                                                                        url: 'https://api.github.com/repos/madhavanmalolan/test',                                                                                                                           forks_url: 'https://api.github.com/repos/madhavanmalolan/test/forks',                                                                                                               keys_url: 'https://api.github.com/repos/madhavanmalolan/test/keys{/key_id}',                                                                                                        collaborators_url: 'https://api.github.com/repos/madhavanmalolan/test/collaborators{/collaborator}',                                                                                teams_url: 'https://api.github.com/repos/madhavanmalolan/test/teams',                                                                                                               hooks_url: 'https://api.github.com/repos/madhavanmalolan/test/hooks',                                                                                                               issue_events_url: 'https://api.github.com/repos/madhavanmalolan/test/issues/events{/number}',                                                                                       events_url: 'https://api.github.com/repos/madhavanmalolan/test/events',                                                                                                             assignees_url: 'https://api.github.com/repos/madhavanmalolan/test/assignees{/user}',                                                                                                branches_url: 'https://api.github.com/repos/madhavanmalolan/test/branches{/branch}',                                                                                                tags_url: 'https://api.github.com/repos/madhavanmalolan/test/tags',                                                                                                                 blobs_url: 'https://api.github.com/repos/madhavanmalolan/test/git/blobs{/sha}',                                                                                                     git_tags_url: 'https://api.github.com/repos/madhavanmalolan/test/git/tags{/sha}',                                                                                                   git_refs_url: 'https://api.github.com/repos/madhavanmalolan/test/git/refs{/sha}',                                                                                                   trees_url: 'https://api.github.com/repos/madhavanmalolan/test/git/trees{/sha}',                                                                                                     statuses_url: 'https://api.github.com/repos/madhavanmalolan/test/statuses/{sha}',                                                                                                   languages_url: 'https://api.github.com/repos/madhavanmalolan/test/languages',                                                                                                       stargazers_url: 'https://api.github.com/repos/madhavanmalolan/test/stargazers',                                                                                                     contributors_url: 'https://api.github.com/repos/madhavanmalolan/test/contributors',                                                                                                 subscribers_url: 'https://api.github.com/repos/madhavanmalolan/test/subscribers',                                                                                                   subscription_url: 'https://api.github.com/repos/madhavanmalolan/test/subscription',                                                                                                 commits_url: 'https://api.github.com/repos/madhavanmalolan/test/commits{/sha}',                                                                                                     git_commits_url: 'https://api.github.com/repos/madhavanmalolan/test/git/commits{/sha}',                                                                                             comments_url: 'https://api.github.com/repos/madhavanmalolan/test/comments{/number}',                                                                                                issue_comment_url: 'https://api.github.com/repos/madhavanmalolan/test/issues/comments{/number}',                                                                                    contents_url: 'https://api.github.com/repos/madhavanmalolan/test/contents/{+path}',                                                                                                 compare_url: 'https://api.github.com/repos/madhavanmalolan/test/compare/{base}...{head}',                                                                                           merges_url: 'https://api.github.com/repos/madhavanmalolan/test/merges',                                                                                                             archive_url: 'https://api.github.com/repos/madhavanmalolan/test/{archive_format}{/ref}',                                                                                            downloads_url: 'https://api.github.com/repos/madhavanmalolan/test/downloads',                                                                                                       issues_url: 'https://api.github.com/repos/madhavanmalolan/test/issues{/number}',                                                                                                    pulls_url: 'https://api.github.com/repos/madhavanmalolan/test/pulls{/number}',                                                                                                      milestones_url: 'https://api.github.com/repos/madhavanmalolan/test/milestones{/number}',                                                                                            notifications_url: 'https://api.github.com/repos/madhavanmalolan/test/notifications{?since,all,participating}',                                                                     labels_url: 'https://api.github.com/repos/madhavanmalolan/test/labels{/name}',                                                                                                      releases_url: 'https://api.github.com/repos/madhavanmalolan/test/releases{/id}',                                                                                                    deployments_url: 'https://api.github.com/repos/madhavanmalolan/test/deployments',                                                                                                   created_at: '2021-06-21T13:19:40Z',                                                                                                                                                 updated_at: '2021-06-21T13:20:10Z',                                                                                                                                                 pushed_at: '2021-06-21T13:20:07Z',                                                                                                                                                  git_url: 'git://github.com/madhavanmalolan/test.git',                                                                                                                               ssh_url: 'git@github.com:madhavanmalolan/test.git',                                                                                                                                 clone_url: 'https://github.com/madhavanmalolan/test.git',                                                                                                                           svn_url: 'https://github.com/madhavanmalolan/test',                                                                                                                                 homepage: null,                                                                                                                                                                     size: 0,                                                                                                                                                                            stargazers_count: 0,                                                                                                                                                                watchers_count: 0,                                                                                                                                                                  language: null,                                                                                                                                                                     has_issues: true,                                                                                                                                                                   has_projects: true,                                                                                                                                                                 has_downloads: true,                                                                                                                                                                has_wiki: true,                                                                                                                                                                     has_pages: false,                                                                                                                                                                   forks_count: 0,                                                                                                                                                                     mirror_url: null,                                                                                                                                                                   archived: false,                                                                                                                                                                    disabled: false,                                                                                                                                                                    open_issues_count: 0,                                                                                                                                                               license: null,                                                                                                                                                                      forks: 0,                                                                                                                                                                           open_issues: 0,                                                                                                                                                                     watchers: 0,                                                                                                                                                                        default_branch: 'main'                                                                                                                                                            },                                                                                                                                                                                  sender: {                                                                                                                                                                             login: 'madhavanmalolan',                                                                                                                                                           id: 2111253,                                                                                                                                                                        node_id: 'MDQ6VXNlcjIxMTEyNTM=',                                                                                                                                                    avatar_url: 'https://avatars.githubusercontent.com/u/2111253?v=4',                                                                                                                  gravatar_id: '',                                                                                                                                                                    url: 'https://api.github.com/users/madhavanmalolan',                                                                                                                                html_url: 'https://github.com/madhavanmalolan',                                                                                                                                     followers_url: 'https://api.github.com/users/madhavanmalolan/followers',                                                                                                            following_url: 'https://api.github.com/users/madhavanmalolan/following{/other_user}',                                                                                               gists_url: 'https://api.github.com/users/madhavanmalolan/gists{/gist_id}',                                                                                                          starred_url: 'https://api.github.com/users/madhavanmalolan/starred{/owner}{/repo}',                                                                                                 subscriptions_url: 'https://api.github.com/users/madhavanmalolan/subscriptions',                                                                                                    organizations_url: 'https://api.github.com/users/madhavanmalolan/orgs',                                                                                                             repos_url: 'https://api.github.com/users/madhavanmalolan/repos',                                                                                                                    events_url: 'https://api.github.com/users/madhavanmalolan/events{/privacy}',                                                                                                        received_events_url: 'https://api.github.com/users/madhavanmalolan/received_events',                                                                                                type: 'User',                                                                                                                                                                       site_admin: false                                                                                                                                                                 },                                                                                                                                                                                  installation: {                                                                                                                                                                       id: 17759648,                                                                                                                                                                       node_id: 'MDIzOkludGVncmF0aW9uSW5zdGFsbGF0aW9uMTc3NTk2NDg='                                                                                                                       }                                                                                                                                                                                 }                  


 * */
module.exports = router;
